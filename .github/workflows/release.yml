name: Publish Libraries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release_version:
        description: "Optional version hint (matches the tag)"
        required: false
        type: string

env:
  RUST_VERSION: "stable"
  PYTHON_VERSION: "3.13"

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish-core:
    name: Publish dinja-core crate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Validate workspace
        run: |
          cargo fmt --all --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo test -p dinja-core --all-features

      - name: Publish crate
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          if [ -z "${CRATES_IO_TOKEN}" ]; then
            echo "CRATES_IO_TOKEN must be provided" >&2
            exit 1
          fi
          cargo publish --package dinja-core --locked --token "${CRATES_IO_TOKEN}"

  publish-python:
    name: Publish dinja PyPI package
    needs: publish-core
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Sync Python dependencies
        working-directory: python-bindings
        run: uv sync --dev

      - name: Run Python tests
        working-directory: python-bindings
        run: uv run pytest

      - name: Publish to PyPI
        working-directory: python-bindings
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "${PYPI_API_TOKEN}" ]; then
            echo "PYPI_API_TOKEN must be provided" >&2
            exit 1
          fi
          uv run maturin publish --locked --skip-existing --username __token__ --password "${PYPI_API_TOKEN}"
