name: Docker Release

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build (leave empty for latest release)'
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag || github.event.release.tag_name }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ inputs.release_tag }}"
          fi
          # Remove 'v' prefix if present
          VERSION=${TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION} from tag: ${TAG}"

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.version.outputs.version }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=Dinja MDX Renderer
            org.opencontainers.image.description=High-performance MDX renderer with component support
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Test Docker image
        run: |
          docker run -d --name test-container -p 8080:8080 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          sleep 5
          curl -f http://localhost:8080/health || exit 1
          docker stop test-container
          docker rm test-container

      - name: Save Docker image to artifact
        run: |
          mkdir -p .artifacts
          SAFE_IMAGE_NAME=$(echo "${{ env.IMAGE_NAME }}" | sed 's/[\/:]/-/g')
          TAR_FILENAME="${SAFE_IMAGE_NAME}-${{ steps.version.outputs.version }}.tar"
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} -o .artifacts/${TAR_FILENAME}

          # Create a checksum
          sha256sum .artifacts/${TAR_FILENAME} > .artifacts/${TAR_FILENAME}.sha256

          # Display info
          ls -lh .artifacts/
          cat .artifacts/${TAR_FILENAME}.sha256

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ steps.version.outputs.version }}
          path: |
            .artifacts/*.tar
            .artifacts/*.sha256
          retention-days: 90

      - name: Create release artifact comment
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const registry = '${{ env.REGISTRY }}';
            const imageName = '${{ env.IMAGE_NAME }}';

            const comment = `## ðŸ³ Docker Images Published

            Docker images for version \`${version}\` have been published to GitHub Container Registry.

            ### Available Tags
            - \`${registry}/${imageName}:${version}\`
            - \`${registry}/${imageName}:latest\`

            ### Pull and Run
            \`\`\`bash
            # Pull the image
            docker pull ${registry}/${imageName}:${version}

            # Run the container
            docker run -p 8080:8080 ${registry}/${imageName}:${version}

            # Or use docker-compose
            # Set IMAGE_TAG=${version} in your .env file
            docker-compose up -d
            \`\`\`

            ### Test the Server
            \`\`\`bash
            curl http://localhost:8080/health
            \`\`\`

            ### Download Offline Image
            Docker image tarball is available in the workflow artifacts for offline installation.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.release.id,
              body: comment
            });

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Docker Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Images" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8080:8080 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
