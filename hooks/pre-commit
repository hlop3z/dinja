#!/bin/bash
#
# Pre-commit hook for dinja project
# Runs comprehensive checks on core and all bindings before allowing commits
#
# Install: ./hooks/install.sh
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track overall status
FAILED=0

# Helper functions
print_header() {
    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_step() {
    echo -e "${YELLOW}→${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_skip() {
    echo -e "${YELLOW}⊘${NC} $1 (skipped)"
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if specific paths have changes
has_changes_in() {
    echo "$STAGED_FILES" | grep -q "^$1" 2>/dev/null
}

# ============================================================================
# RUST CORE CHECKS
# ============================================================================
print_header "Rust Core Checks"

if has_changes_in "core/" || has_changes_in "Cargo"; then
    # Format check
    print_step "Checking Rust formatting..."
    if cargo fmt --all -- --check; then
        print_success "Rust formatting OK"
    else
        print_error "Rust formatting issues found. Run 'cargo fmt --all' to fix."
        FAILED=1
    fi

    # Clippy linting (use -p dinja-core to avoid Python env issues)
    print_step "Running Clippy..."
    if cargo clippy -p dinja-core -- -D warnings 2>/dev/null; then
        print_success "Clippy passed"
    else
        print_error "Clippy found issues"
        FAILED=1
    fi

    # Core tests
    print_step "Running core tests..."
    if cargo test -p dinja-core 2>/dev/null; then
        print_success "Core tests passed"
    else
        print_error "Core tests failed"
        FAILED=1
    fi

    # Check for unused dependencies (if cargo-machete is installed)
    if command_exists cargo-machete; then
        print_step "Checking for unused dependencies..."
        if cargo machete --skip-target-dir 2>/dev/null; then
            print_success "No unused dependencies"
        else
            print_error "Unused dependencies found"
            # Non-fatal warning
        fi
    fi
else
    print_skip "No Rust core changes detected"
fi

# ============================================================================
# PYTHON BINDINGS CHECKS
# ============================================================================
print_header "Python Bindings Checks"

if has_changes_in "python-bindings/"; then
    cd python-bindings

    # Check if uv is available
    if command_exists uv; then
        # Build Python bindings
        print_step "Building Python bindings..."
        if uv run maturin develop --release 2>/dev/null; then
            print_success "Python bindings built"
        else
            print_error "Failed to build Python bindings"
            FAILED=1
            cd ..
        fi

        # Run Python tests
        if [ $FAILED -eq 0 ]; then
            print_step "Running Python tests..."
            if uv run pytest -v 2>/dev/null; then
                print_success "Python tests passed"
            else
                print_error "Python tests failed"
                FAILED=1
            fi
        fi
    else
        print_skip "uv not found - cannot run Python checks"
    fi

    cd ..
else
    print_skip "No Python bindings changes detected"
fi

# ============================================================================
# JAVASCRIPT BINDINGS CHECKS
# ============================================================================
print_header "JavaScript Bindings Checks"

if has_changes_in "js-bindings/"; then
    cd js-bindings

    # Check if npm is available
    if command_exists npm; then
        # Check if node_modules exists
        if [ ! -d "node_modules" ]; then
            print_step "Installing npm dependencies..."
            npm install --silent 2>/dev/null || true
        fi

        # Build JS bindings
        print_step "Building JavaScript bindings..."
        if npm run build 2>/dev/null; then
            print_success "JavaScript bindings built"
        else
            print_error "Failed to build JavaScript bindings"
            FAILED=1
            cd ..
        fi

        # Run JS tests (if test script exists)
        if [ $FAILED -eq 0 ] && grep -q '"test"' package.json 2>/dev/null; then
            print_step "Running JavaScript tests..."
            if npm test 2>/dev/null; then
                print_success "JavaScript tests passed"
            else
                print_error "JavaScript tests failed"
                FAILED=1
            fi
        fi
    else
        print_skip "npm not found - cannot run JavaScript checks"
    fi

    cd ..
else
    print_skip "No JavaScript bindings changes detected"
fi

# ============================================================================
# CROSS-BINDING CONSISTENCY CHECKS
# ============================================================================
print_header "Cross-Binding Consistency Checks"

# Check VERSION file consistency
print_step "Checking version consistency..."
if [ -f "VERSION" ]; then
    VERSION=$(cat VERSION | tr -d '[:space:]')

    # Check Cargo.toml version
    CARGO_VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')

    if [ "$VERSION" != "$CARGO_VERSION" ]; then
        print_error "VERSION ($VERSION) doesn't match Cargo.toml ($CARGO_VERSION)"
        FAILED=1
    else
        print_success "Version consistency OK ($VERSION)"
    fi
else
    print_skip "No VERSION file found"
fi

# Check for common issues in staged files
print_step "Checking for common issues..."
ISSUES_FOUND=0

# Check for debug prints in Rust
if echo "$STAGED_FILES" | grep -q '\.rs$'; then
    if git diff --cached --diff-filter=ACM -- '*.rs' | grep -q 'println!.*DEBUG\|dbg!'; then
        print_error "Debug statements found in Rust files"
        ISSUES_FOUND=1
    fi
fi

# Check for console.log in JS (excluding tests)
if echo "$STAGED_FILES" | grep -q '\.js$'; then
    if git diff --cached --diff-filter=ACM -- '*.js' ':!*test*' | grep -q 'console\.log'; then
        print_error "console.log found in JavaScript files (non-test)"
        ISSUES_FOUND=1
    fi
fi

# Check for breakpoint() in Python
if echo "$STAGED_FILES" | grep -q '\.py$'; then
    if git diff --cached --diff-filter=ACM -- '*.py' | grep -q 'breakpoint()\|pdb\.set_trace'; then
        print_error "Debug breakpoints found in Python files"
        ISSUES_FOUND=1
    fi
fi

if [ $ISSUES_FOUND -eq 0 ]; then
    print_success "No common issues found"
fi

# ============================================================================
# SUMMARY
# ============================================================================
print_header "Pre-commit Summary"

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All checks passed! Proceeding with commit.${NC}"
    exit 0
else
    echo -e "${RED}Some checks failed. Please fix the issues above before committing.${NC}"
    echo -e "${YELLOW}Tip: Use 'git commit --no-verify' to bypass (not recommended)${NC}"
    exit 1
fi
